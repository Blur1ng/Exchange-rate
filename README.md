# Ставки на курс криптовалюты

Проект позволяет пользователям делать ставки на изменение курса криптовалют (например, Bitcoin, Ethereum) за определённый промежуток времени. 
Пользователь выбирает направление (повышение/понижение), сумму ставки и время, через которое будет проверен результат. 
В основе проекта — микросервисная архитектура с использованием современных технологий.

---

## Технологии

- **Бэкенд**: 
  - `FastAPI` — фреймворк для создания API.
  - `SQLAlchemy` — ORM для работы с PostgreSQL.
  - `Pydantic` — валидация данных.
  - `Celery` — обработка отложенных задач.
  - `JWT` — аутентификация пользователей.
  - `Alembic` — управление миграциями баз данных.
  
- **Базы данных**:
  - `PostgreSQL` — основная БД для хранения пользователей и сделок.
  - `Redis` — брокер для Celery + временное хранение данных.

- **Фронтенд**:
  - `JavaScript` + `Fetch API` — взаимодействие с бэкендом.
  - `HTML`/`CSS` — интерфейс.

- **Внешние сервисы**:
  - `CoinMarketCap API` — получение актуальных курсов криптовалют.

---

## Ключевые особенности

### Регистрация и аутентификация
- Пользователь регистрируется с уникальным логином и паролем.
- При входе генерируется JWT-токен, который сохраняется в защищённых куках (`HttpOnly`, `Secure`, `SameSite=Strict`).
- Токен автоматически отправляется в заголовках запросов для доступа к защищённым эндпоинтам.

### Взаимодействие фронтенда и бэкенда
- Фронтенд отправляет запросы к API через `fetch()`.
- Примеры запросов:
  - Получение текущего курса криптовалюты.
  - Создание ставки с указанием времени.
  - Проверка статуса завершённых сделок.

### Отложенные задачи через Celery
- При создании ставки задача добавляется в очередь Redis с задержкой (`countdown`), равной выбранному пользователем времени.
- Celery Worker периодически проверяет очередь и выполняет задачи:
  1. Получает актуальный курс криптовалюты через CoinMarketCap API.
  2. Сравнивает с начальным курсом.
  3. Определяет результат ставки (выигрыш/проигрыш).
  4. Сохраняет результат в PostgreSQL.

### Базы данных
- **PostgreSQL**:
  - `Пользователи`: логин, хеш пароля.
  - `Сделки`: валюта, направление, сумма, время, статус.
  - `Результаты`: прибыль/убыток, время завершения.
- **Redis**:
  - Брокер для Celery.
  - Временное хранение данных о незавершённых сделках.

### ORM и миграции
- `SQLAlchemy` используется для моделей данных и запросов к PostgreSQL.
- `Alembic` управляет миграциями: создание таблиц, обновление схемы.

---

## Запуск проекта

### Требования:
- Python 3.10+
- Установленные PostgreSQL и Redis.
- API-ключ от CoinMarketCap.

### Инструкция:
1. Клонируйте репозиторий:
    ```bash
    git clone https://github.com/ваш-username/ставки-криптовалюты.git
    Установите зависимости:
    bash
    Copy

    pip install -r requirements.txt
    ```
2. Настройте переменные окружения (.env):
    ```ini
    DATABASE_URL=postgresql://user:password@localhost/dbname
    REDIS_URL=redis://localhost:6379/0
    CMC_API_KEY=ваш_api_ключ
    JWT_SECRET=секретный_ключ
    ```
3. Примените миграции:
    ```bash
    alembic upgrade head
    ```
4. Запустите серверы:
    ```bash
    # FastAPI
    uvicorn app.main:app --reload

    # Celery Worker
    celery -A core.celery_con.celery worker --loglevel=info --pool=solo

    # Redis
    redis-server
    ```
### Примеры API-запросов
1. Создание ставки
    ```http
    POST /api/v1/trade_it/
    Body:
    {
      "exchange": "BTC",
      "bet_amount": 100,
      "leverage": 5,
      "direction": "up",
      "time": 5,
      "start_price": 50000
    }
    ```
2. Проверка статуса
    ```http
    GET /api/v1/trade_status/20
    Response:
    {
      "status": "completed",
      "result": "W",
      "profit": 500
    }
    ```
Зачем нужен этот проект?
    - Учебный пример: Демонстрация интеграции FastAPI, Celery, JWT и современных инструментов разработки.
    - Практика: Реализация микросервисной архитектуры с асинхронными задачами.
    - Базовый функционал: Может быть расширен до полноценной торговой платформы.
